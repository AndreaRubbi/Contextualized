
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Death to Cluster Models; Long Live Context Encoders &#8212; Contextualized.ML Documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Contextualized.ML Documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Contextualized.ML
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Quick Start
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../getting-started-intro.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../model-fitting.html">
     Fitting And Analyzing Contextualized Models
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../faq.html">
   Frequently Asked Questions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Models
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="easy_regression.html">
   Contextualized Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="easy_classification.html">
   Contextualized Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="easy_networks.html">
   Contextualized Networks
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/cnellington/contextualized/master?urlpath=tree/demos/custom_models.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/cnellington/contextualized"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/cnellington/contextualized/issues/new?title=Issue%20on%20page%20%2Fdemos/custom_models.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/demos/custom_models.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-1-regression-models">
   Section 1: Regression Models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-overview">
     1.1: Problem Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-thoughts">
     1.2: Initial Thoughts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#realistic-constraints">
     1.3 Realistic Constraints
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#understanding-the-problem">
     1.4: Understanding the Problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approaching-the-problem">
     1.5: Approaching the Problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#population-regression">
     1.6: Population Regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#context-clustered-regression">
     1.7: Context-clustered Regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#context-clustered-regression-with-noise">
     1.7: Context-clustered Regression with Noise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-regression">
     1.8: Contextualized Regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-regression-on-noise">
     1.9: Contextualized Regression on Noise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-regression-with-some-noise">
     1.9: Contextualized Regression with Some Noise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#throw-a-deep-learner-at-it">
     1.10: Throw a deep learner at it!
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-2-graphical-models">
   Section 2: Graphical Models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-setup-bayesian-networks">
     2.1: Problem Setup: Bayesian Networks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#population-network">
     2.2: Population Network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#context-clustered-networks">
     2.3: Context-clustered Networks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-networks">
     2.4: Contextualized Networks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualizing-networks">
     2.4 Visualizing Networks
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Death to Cluster Models; Long Live Context Encoders</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-1-regression-models">
   Section 1: Regression Models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-overview">
     1.1: Problem Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-thoughts">
     1.2: Initial Thoughts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#realistic-constraints">
     1.3 Realistic Constraints
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#understanding-the-problem">
     1.4: Understanding the Problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approaching-the-problem">
     1.5: Approaching the Problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#population-regression">
     1.6: Population Regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#context-clustered-regression">
     1.7: Context-clustered Regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#context-clustered-regression-with-noise">
     1.7: Context-clustered Regression with Noise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-regression">
     1.8: Contextualized Regression
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-regression-on-noise">
     1.9: Contextualized Regression on Noise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-regression-with-some-noise">
     1.9: Contextualized Regression with Some Noise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#throw-a-deep-learner-at-it">
     1.10: Throw a deep learner at it!
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-2-graphical-models">
   Section 2: Graphical Models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-setup-bayesian-networks">
     2.1: Problem Setup: Bayesian Networks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#population-network">
     2.2: Population Network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#context-clustered-networks">
     2.3: Context-clustered Networks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contextualized-networks">
     2.4: Contextualized Networks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualizing-networks">
     2.4 Visualizing Networks
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="death-to-cluster-models-long-live-context-encoders">
<h1>Death to Cluster Models; Long Live Context Encoders<a class="headerlink" href="#death-to-cluster-models-long-live-context-encoders" title="Permalink to this headline">#</a></h1>
<p>Modeling allows us to estimate useful parameters from data while ignoring noise, and then interpret these parameters as general mechanisms in complex systems. Traditional approaches to parameter estimation break down when true parameters vary continuously from sample to sample, which is often the case in biological systems. Our framework remedies this by estimating N models for N samples simultaneously, sharing information between each estimation task. We do this by learning to estimate parameters as a function of sample context, combining modern deep learning with classic statistical inference.</p>
<p>Outline of this demo:</p>
<ul class="simple">
<li><p>Linear Models: population vs. cluster vs. contextualized models, compared on prediction mean squared error (MSE) and parameter MSE</p></li>
<li><p>Graphical Models: population vs. cluster vs. contextualized models, compared on prediction MSE and parameter MSE</p></li>
</ul>
<section id="section-1-regression-models">
<h2>Section 1: Regression Models<a class="headerlink" href="#section-1-regression-models" title="Permalink to this headline">#</a></h2>
<section id="problem-overview">
<h3>1.1: Problem Overview<a class="headerlink" href="#problem-overview" title="Permalink to this headline">#</a></h3>
<p>Say we have a dataset of patients with a disease, where we’ve measured each patient’s response to treatments A and B under an uninformed (randomized) dosing of each treatment, as well as their risk factors (diet, exercise). We know that diet and exercise have some effect on response to treatment, but it isn’t a simple or obvious relationship. Formally, we’ll define this as a linear model with context-varying parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Context</span><span class="p">:</span>            <span class="n">C0</span><span class="p">,</span> <span class="n">C1</span> <span class="o">~</span> <span class="n">Uniform</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">Treatment</span> <span class="n">dose</span><span class="p">:</span>     <span class="n">X0</span><span class="p">,</span> <span class="n">X1</span> <span class="o">~</span> <span class="n">Uniform</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">Treatment</span> <span class="n">effect</span><span class="p">:</span>   <span class="n">W0</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">+</span> <span class="n">C1</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span> <span class="n">W1</span> <span class="o">=</span> <span class="n">C0</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C1</span>
<span class="n">Treatment</span> <span class="n">response</span><span class="p">:</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">X0</span> <span class="n">W0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">X1</span> <span class="n">W1</span><span class="p">)</span>
</pre></div>
</div>
<p>We want to estimate the treatment effect <span class="math notranslate nohighlight">\(\hat{W}\)</span> based on observations <span class="math notranslate nohighlight">\(C, X, Y\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate our data and do some plotting</span>
<span class="n">n_z</span> <span class="o">=</span> <span class="mi">75</span>
<span class="n">Z_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_z</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_z</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Z_space</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">z_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Z_space</span><span class="p">):</span>
        <span class="n">Z</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_z</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">z_i</span><span class="p">,</span> <span class="n">z_j</span><span class="p">]</span>
<span class="n">z_samples</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">Z_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">z_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">Z_labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Z_labels</span><span class="p">)</span>
<span class="n">W</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
<span class="n">W</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> 
<span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">z_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># W += np.random.normal(0, .1, W.shape)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="c1"># Y += np.random.normal(0, .1, Y.shape)</span>

<span class="k">def</span> <span class="nf">get_gaps</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> 
    <span class="n">gap_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">],</span>
    <span class="p">])</span>
    <span class="n">gap_radius</span> <span class="o">=</span> <span class="mf">.1</span>
    <span class="n">gap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">gap_center</span> <span class="ow">in</span> <span class="n">gap_centers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dist</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">gap_center</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">gap_radius</span><span class="p">:</span>
                <span class="n">gap_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">gap_idx</span>
    
    
<span class="n">gap_idx</span> <span class="o">=</span> <span class="n">get_gaps</span><span class="p">(</span><span class="n">Z_labels</span><span class="p">)</span>
<span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="o">=</span> <span class="n">gap_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gap_idx</span> <span class="o">==</span> <span class="mi">1</span>
<span class="n">split</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="n">test_idx</span><span class="p">])</span>
<span class="n">Z_train</span><span class="p">,</span> <span class="n">Z_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">Z_labels</span><span class="p">)</span>
<span class="n">C_train_pre</span><span class="p">,</span> <span class="n">C_test_pre</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<span class="n">C_mean</span><span class="p">,</span> <span class="n">C_std</span> <span class="o">=</span> <span class="n">C_train_pre</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">C_train_pre</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">C_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">C_train_pre</span> <span class="o">-</span> <span class="n">C_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">C_std</span>
<span class="n">C_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">C_test_pre</span> <span class="o">-</span> <span class="n">C_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">C_std</span>
<span class="n">W_train</span><span class="p">,</span> <span class="n">W_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Preliminary Exploration and Plotting</span>
<span class="k">def</span> <span class="nf">cbar</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">arr</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">c</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Plot the context and treatment effect spaces</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">C</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Eats Healthy&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Exercises&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Context: Risk Factors&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">C</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">C</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Effect of Treatment A per dose&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effect of Treatment B per dose&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True Parameters: Treatment Effect&#39;</span><span class="p">)</span>

<span class="n">cplot</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">cbar</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dose of Treatment A&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dose of Treatment B&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Patient Outcomes&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cplot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatment Response&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/custom_models_4_0.png" src="../_images/custom_models_4_0.png" />
</div>
</div>
</section>
<section id="initial-thoughts">
<h3>1.2: Initial Thoughts<a class="headerlink" href="#initial-thoughts" title="Permalink to this headline">#</a></h3>
<p>Notice that the patient outcomes seem noisy, but there is no noise in the sample generation.
The variance of patient responses is due to meaningful variation in each patient’s model parameters.
We never observe true parameters in real life, so it’s easy to attribute variation to meaningless noise.
Here, we won’t have that luxury: we’ll compare all of our estimates against the true parameters to see how different estimators can generalize over the whole space.</p>
</section>
<section id="realistic-constraints">
<h3>1.3 Realistic Constraints<a class="headerlink" href="#realistic-constraints" title="Permalink to this headline">#</a></h3>
<p>Let’s say our dataset only contains highly localized populations of samples but we need to generalize to a much broader population.
Below, we visualize the observed and unobserved populations, and pick two patients of interest to see how different methods generalize near observed populations and far away from observed populations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the observed and unobserved samples</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C_test_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_test_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;unobserved patients&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C_train_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_train_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed patients&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Eats Healthy&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Exercises&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Context: Risk Factors&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;unobserved patients&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed patients&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Effect of Treatment A per dose&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effect of Treatment B per dose&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True Parameters: Treatment Effect&#39;</span><span class="p">)</span>

<span class="n">cplot</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">cbar</span><span class="p">(</span><span class="n">Y_train</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dose of Treatment A&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dose of Treatment B&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Patient Outcomes (Observed)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cplot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatment Response&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Identify patients of interest</span>
<span class="n">C_patients_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">.6</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">W_patients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">C_patients_pre</span><span class="p">)</span>
<span class="n">W_patients</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_patients_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">C_patients_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
<span class="n">W_patients</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_patients_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C_patients_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> 

<span class="n">C_patients</span> <span class="o">=</span> <span class="p">(</span><span class="n">C_patients_pre</span> <span class="o">-</span> <span class="n">C_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">C_std</span>
<span class="n">X_patients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">W_patients</span><span class="p">)</span>
<span class="n">Y_patients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X_patients</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C_test_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_test_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;unobserved&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C_train_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_train_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C_patients_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_patients_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;patients of interest&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Eats Healthy&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Exercises&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Context: Risk Factors&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;unobserved patients&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observed patients&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_patients</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_patients</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;patients of interest&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Effect of Treatment A per dose&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effect of Treatment B per dose&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True Parameters: Treatment Effect&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1"># plt.savefig(&#39;figures/patient_trueeffects.png&#39;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/custom_models_6_0.png" src="../_images/custom_models_6_0.png" />
<img alt="../_images/custom_models_6_1.png" src="../_images/custom_models_6_1.png" />
</div>
</div>
</section>
<section id="understanding-the-problem">
<h3>1.4: Understanding the Problem<a class="headerlink" href="#understanding-the-problem" title="Permalink to this headline">#</a></h3>
<p>It is important to generalize to the unobserved areas because because these gaps often represent:</p>
<ul class="simple">
<li><p>Undersampled / underrepresented patient populations</p></li>
<li><p>Undocumented / undiscovered treatments</p></li>
<li><p>Rare cell types / diseases / risk factors</p></li>
</ul>
<p>Let’s pre-define our MSE evaluation metric and visualization</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mse</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="p">((</span><span class="n">true</span> <span class="o">-</span> <span class="n">pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_all</span><span class="p">(</span><span class="n">w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">w_hat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">w_hat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;predicted effects (all unobserved)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>


    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_test</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_test</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;true effects (unobserved patients)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;true effects (observed patients)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;predicted effects (unobserved patients)&#39;</span><span class="p">)</span>  <span class="c1"># dummy plot for legend</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">W_patients</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">W_patients</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;true effects (patients of interest)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">patient_w_hat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">patient_w_hat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;predicted effects (patients of interest)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># subplot axis hack</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Effect of treatment A per dose&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Effect of treatment B per dose&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Parameters: Treatment Effects&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1">#     plt.savefig(f&#39;figures/{model_name}_effects.png&#39;, dpi=300)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="approaching-the-problem">
<h3>1.5: Approaching the Problem<a class="headerlink" href="#approaching-the-problem" title="Permalink to this headline">#</a></h3>
<p>We’ll compare three approaches to modeling treatment response in this patient population:</p>
<ul class="simple">
<li><p>Population Regression: Disregard context, learn a single model for all patients</p></li>
<li><p>Context-clustered Regression: We know context has some effect on model parameters, so cluster patients according to context and learn a model for each cluster</p></li>
<li><p>Contextualized Regression: Learn the function from context to model parameters</p></li>
</ul>
<p>For each of these models, we’ll evaluate how well they recover the following in terms of MSE:</p>
<ul class="simple">
<li><p>True patient outcomes / treatment response</p></li>
<li><p>True model parameters</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define our models</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">contextualized.regression</span> <span class="kn">import</span> <span class="n">ContextualizedRegression</span><span class="p">,</span> <span class="n">RegressionTrainer</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks.early_stopping</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="k">class</span> <span class="nc">NaiveRegression</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">predict_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">predict_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">w_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">w_hat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y_hat</span>


<span class="k">class</span> <span class="nc">ClusterRegression</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">NaiveRegression</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wdim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">):</span>
            <span class="n">k_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">k</span>
            <span class="n">X_k</span><span class="p">,</span> <span class="n">Y_k</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">k_idx</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">k_idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_k</span><span class="p">,</span> <span class="n">Y_k</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
            
    <span class="k">def</span> <span class="nf">predict_l</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmeans</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_l</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">w_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">==</span> <span class="n">label</span>
            <span class="n">X_l</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span>
            <span class="n">w_hat</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">X_l</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w_hat</span>
    
    <span class="k">def</span> <span class="nf">predict_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_l</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">==</span> <span class="n">label</span>
            <span class="n">X_l</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span>
            <span class="n">y_hat</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">predict_y</span><span class="p">(</span><span class="n">X_l</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_hat</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="population-regression">
<h3>1.6: Population Regression<a class="headerlink" href="#population-regression" title="Permalink to this headline">#</a></h3>
<p>In our initial pass we learn a single model from data, which turns out to be the average of all our true models.
This has terrible coverage of our model space, and completely disregards context.</p>
<p>The predicted effects show how this model only learns a single general trend and ignores meaningful variation among patients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Population regression</span>
<span class="n">naive_model</span> <span class="o">=</span> <span class="n">NaiveRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>

<span class="n">w_hat</span> <span class="o">=</span> <span class="n">naive_model</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">patient_w_hat</span> <span class="o">=</span> <span class="n">naive_model</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">X_patients</span><span class="p">)</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">naive_model</span><span class="o">.</span><span class="n">predict_y</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">plot_all</span><span class="p">(</span><span class="n">w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">)</span>
<span class="n">y_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">)</span>
<span class="n">w_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">W_test</span><span class="p">,</span> <span class="n">w_hat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Treatment-response error: </span><span class="se">\t</span><span class="si">{</span><span class="n">y_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect-size error: </span><span class="se">\t\t</span><span class="si">{</span><span class="n">w_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">5.05</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">naive_model</span><span class="o">.</span><span class="n">predict_y</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dose of treatment A&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dose of treatment B&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Change in Health&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Treatment Response (Estimated)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1"># plt.savefig(&#39;figures/population_responses.png&#39;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/custom_models_12_0.png" src="../_images/custom_models_12_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Treatment-response error: 	0.31697846565694665
Effect-size error: 		0.4653129145326966
</pre></div>
</div>
<img alt="../_images/custom_models_12_2.png" src="../_images/custom_models_12_2.png" />
</div>
</div>
</section>
<section id="context-clustered-regression">
<h3>1.7: Context-clustered Regression<a class="headerlink" href="#context-clustered-regression" title="Permalink to this headline">#</a></h3>
<p>Context-clustering does much better on the unobserved patients than the population model, but we’re severely constrained by the breadth of the data we’ve observed.
For the patient of interest near our observed data, this will work just fine.
However, with higher dimensional data the dataset coverage will always be sparse and new patients rarely match an observed population exactly.</p>
<p>Overall, we get very poor coverage of the overall parameter space, and our our outlier patient will have problems with her treatment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cluster regression</span>
<span class="n">cluster_model</span> <span class="o">=</span> <span class="n">ClusterRegression</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">C_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">w_hat</span> <span class="o">=</span> <span class="n">cluster_model</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">C_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">cluster_model</span><span class="o">.</span><span class="n">predict_y</span><span class="p">(</span><span class="n">C_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
<span class="n">patient_w_hat</span> <span class="o">=</span> <span class="n">cluster_model</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">C_patients</span><span class="p">,</span> <span class="n">X_patients</span><span class="p">)</span>

<span class="n">plot_all</span><span class="p">(</span><span class="n">w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="s1">&#39;cluster_neat&#39;</span><span class="p">)</span>

<span class="n">y_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">)</span>
<span class="n">w_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">W_test</span><span class="p">,</span> <span class="n">w_hat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Treatment-response error: </span><span class="se">\t</span><span class="si">{</span><span class="n">y_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect-size error: </span><span class="se">\t\t</span><span class="si">{</span><span class="n">w_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/custom_models_14_0.png" src="../_images/custom_models_14_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Treatment-response error: 	0.09904819958191834
Effect-size error: 		0.1476582082183498
</pre></div>
</div>
</div>
</div>
</section>
<section id="context-clustered-regression-with-noise">
<h3>1.7: Context-clustered Regression with Noise<a class="headerlink" href="#context-clustered-regression-with-noise" title="Permalink to this headline">#</a></h3>
<p>When we add noise parameters to the context, the cluster approach degrades.
Because we’re not estimating a function, it’s difficult to do feature selection beyond 1st or 2nd order (1 or 2-feature) effects.
Here, the coverage we get is due to noisy context and new samples will tend to align with the wrong clusters.</p>
<p>Clustering in this realistic case marginally improves on the population model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Regression from noise-context clustering</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">noise_train</span><span class="p">,</span> <span class="n">noise_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
<span class="n">noise_mean</span><span class="p">,</span> <span class="n">noise_std</span> <span class="o">=</span> <span class="n">noise_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">noise_train</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">noise_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_train</span> <span class="o">-</span> <span class="n">noise_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">noise_std</span>
<span class="n">noise_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_test</span> <span class="o">-</span> <span class="n">noise_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">noise_std</span>
<span class="n">C_noise_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">C_train</span><span class="p">,</span> <span class="n">noise_train</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">C_noise_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">C_test</span><span class="p">,</span> <span class="n">noise_test</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">C_noise_patients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">C_patients</span><span class="p">,</span> <span class="n">noise_test</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">C_patients</span><span class="p">)]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">cluster_model</span> <span class="o">=</span> <span class="n">ClusterRegression</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">C_noise_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">w_hat</span> <span class="o">=</span> <span class="n">cluster_model</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">C_noise_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">cluster_model</span><span class="o">.</span><span class="n">predict_y</span><span class="p">(</span><span class="n">C_noise_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
<span class="n">patient_w_hat</span> <span class="o">=</span> <span class="n">cluster_model</span><span class="o">.</span><span class="n">predict_w</span><span class="p">(</span><span class="n">C_noise_patients</span><span class="p">,</span> <span class="n">X_patients</span><span class="p">)</span>

<span class="n">plot_all</span><span class="p">(</span><span class="n">w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="s1">&#39;cluster_noisy&#39;</span><span class="p">)</span>

<span class="n">y_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">)</span>
<span class="n">w_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">W_test</span><span class="p">,</span> <span class="n">w_hat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response error: </span><span class="si">{</span><span class="n">y_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect-size error: </span><span class="si">{</span><span class="n">w_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/custom_models_16_0.png" src="../_images/custom_models_16_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response error: 0.1344722440998877
Effect-size error: 0.20065781009406908
</pre></div>
</div>
</div>
</div>
</section>
<section id="contextualized-regression">
<h3>1.8: Contextualized Regression<a class="headerlink" href="#contextualized-regression" title="Permalink to this headline">#</a></h3>
<p>Now let’s learn the function from context to model parameters with our approach.
We get much better generalization and coverage of the parameter space by learning how context affects our models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Regression from context encoding</span>
<span class="n">encoder_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ContextualizedRegression</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">encoder_kwargs</span><span class="o">=</span><span class="n">encoder_kwargs</span><span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">C_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">C_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">patient_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">C_patients</span><span class="p">,</span> <span class="n">X_patients</span><span class="p">,</span> <span class="n">Y_patients</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">RegressionTrainer</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">auto_lr_find</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">)</span>

<span class="n">w_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataloader</span><span class="p">)</span>
<span class="n">w_hat</span> <span class="o">=</span> <span class="n">w_hat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_test</span> <span class="o">*</span> <span class="n">w_hat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="n">patient_w_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">patient_dataloader</span><span class="p">)</span>
<span class="n">patient_w_hat</span> <span class="o">=</span> <span class="n">patient_w_hat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="n">plot_all</span><span class="p">(</span><span class="n">w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="s1">&#39;encoder&#39;</span><span class="p">)</span>

<span class="n">y_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">)</span>
<span class="n">w_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">W_test</span><span class="p">,</span> <span class="n">w_hat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response error: </span><span class="si">{</span><span class="n">y_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect-size error: </span><span class="si">{</span><span class="n">w_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TPU available: False, using: 0 TPU cores
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IPU available: False, using: 0 IPUs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HPU available: False, using: 0 HPUs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/homebrew/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1789: UserWarning: MPS available but not used. Set `accelerator` and `devices` using `Trainer(accelerator=&#39;mps&#39;, devices=1)`.
  rank_zero_warn(
/opt/homebrew/lib/python3.10/site-packages/pytorch_lightning/trainer/configuration_validator.py:107: PossibleUserWarning: You defined a `validation_step` but have no `val_dataloader`. Skipping val loop.
  rank_zero_warn(

  | Name      | Type             | Params
-----------------------------------------------
0 | metamodel | SubtypeMetamodel | 1.0 K 
-----------------------------------------------
1.0 K     Trainable params
0         Non-trainable params
1.0 K     Total params
0.004     Total estimated model params size (MB)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/homebrew/lib/python3.10/site-packages/pytorch_lightning/trainer/connectors/data_connector.py:236: PossibleUserWarning: The dataloader, train_dataloader, does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` (try 10 which is the number of cpus on this machine) in the `DataLoader` init to improve performance.
  rank_zero_warn(
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "9652b1bac7f0449fa3f67f47a9092d25"}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`Trainer.fit` stopped: `max_epochs=50` reached.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/homebrew/lib/python3.10/site-packages/pytorch_lightning/trainer/connectors/data_connector.py:236: PossibleUserWarning: The dataloader, predict_dataloader 0, does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` (try 10 which is the number of cpus on this machine) in the `DataLoader` init to improve performance.
  rank_zero_warn(
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "c5e2d72ffe6c4665ae820caa2dcf738e"}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/homebrew/lib/python3.10/site-packages/pytorch_lightning/loops/epoch/prediction_epoch_loop.py:174: UserWarning: Lightning couldn&#39;t infer the indices fetched for your dataloader.
  warning_cache.warn(&quot;Lightning couldn&#39;t infer the indices fetched for your dataloader.&quot;)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "340ed20fb8b946cba6865e5ea7c36239"}
</script><img alt="../_images/custom_models_18_12.png" src="../_images/custom_models_18_12.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response error: 0.029458397603001472
Effect-size error: 0.04295388216110779
</pre></div>
</div>
</div>
</div>
</section>
<section id="contextualized-regression-on-noise">
<h3>1.9: Contextualized Regression on Noise<a class="headerlink" href="#contextualized-regression-on-noise" title="Permalink to this headline">#</a></h3>
<p>For a quick sanity check, let’s test what happens when we feed our context encoder <strong>only</strong> noise.
We see that for a completely uninformative context, we can do no worse than the population model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Regression from noise encoding</span>
<span class="n">encoder_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ContextualizedRegression</span><span class="p">(</span><span class="n">noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">encoder_kwargs</span><span class="o">=</span><span class="n">encoder_kwargs</span><span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">noise_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">noise_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">patient_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">noise_test</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">C_patients</span><span class="p">)],</span> <span class="n">X_patients</span><span class="p">,</span> <span class="n">Y_patients</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">RegressionTrainer</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">auto_lr_find</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">)</span>

<span class="n">w_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataloader</span><span class="p">)</span>
<span class="n">w_hat</span> <span class="o">=</span> <span class="n">w_hat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_test</span> <span class="o">*</span> <span class="n">w_hat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="n">patient_w_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">patient_dataloader</span><span class="p">)</span>
<span class="n">patient_w_hat</span> <span class="o">=</span> <span class="n">patient_w_hat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="n">plot_all</span><span class="p">(</span><span class="n">w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="s1">&#39;encoder_noise&#39;</span><span class="p">)</span>

<span class="n">y_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">)</span>
<span class="n">w_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">W_test</span><span class="p">,</span> <span class="n">w_hat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response error: </span><span class="si">{</span><span class="n">y_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect-size error: </span><span class="si">{</span><span class="n">w_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TPU available: False, using: 0 TPU cores
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IPU available: False, using: 0 IPUs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HPU available: False, using: 0 HPUs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  | Name      | Type             | Params
-----------------------------------------------
0 | metamodel | SubtypeMetamodel | 3.2 K 
-----------------------------------------------
3.2 K     Trainable params
0         Non-trainable params
3.2 K     Total params
0.013     Total estimated model params size (MB)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "82ef0339f5c34ed0be066c06535a870b"}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`Trainer.fit` stopped: `max_epochs=2` reached.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "f3a707fb0cf24767b6fb68b4675f419d"}
</script><script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "3a5186ea28cb494f8b21a8fc33c36b2e"}
</script><img alt="../_images/custom_models_20_9.png" src="../_images/custom_models_20_9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response error: 0.35721873007464
Effect-size error: 0.5262089972064848
</pre></div>
</div>
</div>
</div>
</section>
<section id="contextualized-regression-with-some-noise">
<h3>1.9: Contextualized Regression with Some Noise<a class="headerlink" href="#contextualized-regression-with-some-noise" title="Permalink to this headline">#</a></h3>
<p>Now, we can use the context encoder to do automatic feature selection and knowledge distillation.
Because only some features are useful, the context encoder learns to use these over the noise features and produces a near-identical mapping as the contextualized regression with no noise in 1.7.</p>
<p>With interpretable deep learning frameworks like generalized additive models, we can discover the exact effect of each context feature on the model parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Regression from noisy context encoding</span>
<span class="n">encoder_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ContextualizedRegression</span><span class="p">(</span><span class="n">C_noise_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">encoder_kwargs</span><span class="o">=</span><span class="n">encoder_kwargs</span><span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">C_noise_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">C_noise_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">patient_dataloader</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">C_noise_patients</span><span class="p">,</span> <span class="n">X_patients</span><span class="p">,</span> <span class="n">Y_patients</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">RegressionTrainer</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">auto_lr_find</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">)</span>

<span class="n">w_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataloader</span><span class="p">)</span>
<span class="n">w_hat</span> <span class="o">=</span> <span class="n">w_hat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_test</span> <span class="o">*</span> <span class="n">w_hat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="n">patient_w_hat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">patient_dataloader</span><span class="p">)</span>
<span class="n">patient_w_hat</span> <span class="o">=</span> <span class="n">patient_w_hat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="n">plot_all</span><span class="p">(</span><span class="n">w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="s1">&#39;encoder_somenoise&#39;</span><span class="p">)</span>

<span class="n">y_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">)</span>
<span class="n">w_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">W_test</span><span class="p">,</span> <span class="n">w_hat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response error: </span><span class="si">{</span><span class="n">y_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect-size error: </span><span class="si">{</span><span class="n">w_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (mps), used: False
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TPU available: False, using: 0 TPU cores
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IPU available: False, using: 0 IPUs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HPU available: False, using: 0 HPUs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  | Name      | Type             | Params
-----------------------------------------------
0 | metamodel | SubtypeMetamodel | 3.3 K 
-----------------------------------------------
3.3 K     Trainable params
0         Non-trainable params
3.3 K     Total params
0.013     Total estimated model params size (MB)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "6b2dfaea9f78467c964b85e19393bd0d"}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`Trainer.fit` stopped: `max_epochs=50` reached.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "6083e23ee8da484fab363a5011dc40e6"}
</script><script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "f893ed4fe05a47abafba1338ab526521"}
</script><img alt="../_images/custom_models_22_9.png" src="../_images/custom_models_22_9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response error: 0.02589860551200187
Effect-size error: 0.037980014609542305
</pre></div>
</div>
</div>
</div>
</section>
<section id="throw-a-deep-learner-at-it">
<h3>1.10: Throw a deep learner at it!<a class="headerlink" href="#throw-a-deep-learner-at-it" title="Permalink to this headline">#</a></h3>
<p>Given that our approach requires the use of a deep learner, it is natural to wonder whether the “secret sauce” here is our formulation or the deep learner itself.
Specificially, we believe our approach succeeds because it enforces an explicit representation of model parameters in the deep learner, but we can also see what happens when this explicit representation is removed.
For linear models, we can use the differentiability of neural networks to discover implicit representations of feature derivatives (i.e. linear model parameters)!</p>
<p>By training a standard multi-layer perceptron (neural network) to predict outcomes from context and dose, we can then use standard backpropagation to find the gradient of the outcome with respect to the dose features and infer the implicit parameters.</p>
<p>Below, you’ll see that the implicit model representation is highly disorganized compared to our approach.
We believe this might be because our approach reduces the hypothesis space of potential models, requiring a much smaller sample complexity to learn.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># gradient models from MLP(CX) -&gt; Y</span>
<span class="kn">from</span> <span class="nn">contextualized.modules</span> <span class="kn">import</span> <span class="n">MLP</span>

<span class="k">def</span> <span class="nf">get_grad</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
    <span class="n">X</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">yhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">w_hat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">X</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">w_hat</span>

<span class="n">CX</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">CX_patients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">C_patients</span><span class="p">,</span> <span class="n">X_patients</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Y_patients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y_patients</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">CX_train</span><span class="p">,</span> <span class="n">CX_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">CX</span><span class="p">)</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">CX</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">mlp</span><span class="p">(</span><span class="n">CX_train</span><span class="p">),</span> <span class="n">Y_train</span><span class="p">)</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="n">train_w_hat_train</span> <span class="o">=</span> <span class="n">get_grad</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">CX_train</span><span class="p">)[:,</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]</span>
<span class="n">test_w_hat</span> <span class="o">=</span> <span class="n">get_grad</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">CX_test</span><span class="p">)[:,</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]</span>
<span class="n">patient_w_hat</span> <span class="o">=</span> <span class="n">get_grad</span><span class="p">(</span><span class="n">mlp</span><span class="p">,</span> <span class="n">CX_patients</span><span class="p">)[:,</span><span class="o">-</span><span class="n">X_patients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]</span>
<span class="n">plot_all</span><span class="p">(</span><span class="n">test_w_hat</span><span class="p">,</span> <span class="n">patient_w_hat</span><span class="p">,</span> <span class="s1">&#39;cx_mlp&#39;</span><span class="p">)</span>

<span class="n">y_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">mlp</span><span class="p">(</span><span class="n">CX_test</span><span class="p">))</span>
<span class="n">w_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">W_test</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">test_w_hat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response error: </span><span class="si">{</span><span class="n">y_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect-size error: </span><span class="si">{</span><span class="n">w_mse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/custom_models_24_0.png" src="../_images/custom_models_24_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response error: 0.053487520664930344
Effect-size error: 0.1030619740486145
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="section-2-graphical-models">
<h2>Section 2: Graphical Models<a class="headerlink" href="#section-2-graphical-models" title="Permalink to this headline">#</a></h2>
<section id="problem-setup-bayesian-networks">
<h3>2.1: Problem Setup: Bayesian Networks<a class="headerlink" href="#problem-setup-bayesian-networks" title="Permalink to this headline">#</a></h3>
<p>We take a similar approach here, simulating true Bayesian networks according to context and evaluating population, cluster, and contextualized network models in terms of how well they represent the samples they’re assigned to (model MSE) and how close the estimated parameters are to the true parameters (parameter MSE).</p>
<p>We use <a class="reference external" href="https://arxiv.org/abs/1803.01422">NO-TEARS</a> to learn Bayesian networks with standard optimization libraries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad.callbacks</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad.torch_notmad</span> <span class="kn">import</span> <span class="n">NOTMAD_model</span>
<span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad.datamodules</span> <span class="kn">import</span> <span class="n">CX_DataModule</span>
<span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad.baselines</span> <span class="kn">import</span> <span class="n">BayesianNetwork</span><span class="p">,</span> <span class="n">GroupedNetworks</span><span class="p">,</span> <span class="n">project_all</span><span class="p">,</span> <span class="n">dag_pred</span><span class="p">,</span> <span class="n">mse_loss</span>
<span class="kn">from</span> <span class="nn">contextualized.dags.notmad_helpers.simulation</span> <span class="kn">import</span> <span class="n">simulate_linear_sem</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">dag_pred_torch</span> <span class="o">=</span> <span class="n">dag_pred</span>
<span class="n">dag_pred</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">dag_pred_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">pytorch_lightning</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad.callbacks</span> <span class="kn">import</span> <span class="o">*</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad.torch_notmad</span> <span class="kn">import</span> <span class="n">NOTMAD_model</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad.datamodules</span> <span class="kn">import</span> <span class="n">CX_DataModule</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;contextualized.dags.torch_notmad&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextualized.dags.torch_notmad</span> <span class="kn">import</span> <span class="n">baselines</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">baselines</span><span class="p">)</span>
<span class="n">BayesianNetwork</span> <span class="o">=</span> <span class="n">baselines</span><span class="o">.</span><span class="n">BayesianNetwork</span>
<span class="n">project_all</span> <span class="o">=</span> <span class="n">baselines</span><span class="o">.</span><span class="n">project_all</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="c1"># C = np.ones((n, 1))</span>
<span class="n">blank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<span class="n">W_00</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_01</span> <span class="o">=</span> <span class="n">C</span><span class="o">-</span><span class="mi">2</span>
<span class="c1"># W_01 = np.ones_like(C)</span>
<span class="n">W_02</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_03</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_10</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_11</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_12</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_13</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_20</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_21</span> <span class="o">=</span> <span class="n">C</span><span class="o">**</span><span class="mi">2</span>
<span class="n">W_22</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_23</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_30</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W_31</span> <span class="o">=</span> <span class="n">C</span><span class="o">**</span><span class="mi">3</span>
<span class="n">W_32</span> <span class="o">=</span> <span class="n">C</span>
<span class="n">W_33</span> <span class="o">=</span> <span class="n">blank</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="n">W_00</span><span class="p">,</span> <span class="n">W_01</span><span class="p">,</span> <span class="n">W_02</span><span class="p">,</span> <span class="n">W_03</span><span class="p">],</span>
    <span class="p">[</span><span class="n">W_10</span><span class="p">,</span> <span class="n">W_11</span><span class="p">,</span> <span class="n">W_12</span><span class="p">,</span> <span class="n">W_13</span><span class="p">],</span>
    <span class="p">[</span><span class="n">W_20</span><span class="p">,</span> <span class="n">W_21</span><span class="p">,</span> <span class="n">W_22</span><span class="p">,</span> <span class="n">W_23</span><span class="p">],</span>
    <span class="p">[</span><span class="n">W_30</span><span class="p">,</span> <span class="n">W_31</span><span class="p">,</span> <span class="n">W_32</span><span class="p">,</span> <span class="n">W_33</span><span class="p">],</span>
<span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">simulate_linear_sem</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;gauss&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">W</span><span class="p">])</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">C</span> <span class="o">&gt;</span> <span class="mf">1.7</span><span class="p">,</span> <span class="n">C</span> <span class="o">&lt;</span> <span class="mf">1.9</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">test_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="o">~</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">split</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="n">test_idx</span><span class="p">])</span>
<span class="n">W_train</span><span class="p">,</span> <span class="n">W_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">C_train</span><span class="p">,</span> <span class="n">C_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="population-network">
<h3>2.2: Population Network<a class="headerlink" href="#population-network" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Population Model</span>
<span class="n">notears</span> <span class="o">=</span> <span class="n">BayesianNetwork</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

<span class="n">naive_preds_train</span> <span class="o">=</span> <span class="n">project_all</span><span class="p">(</span><span class="n">notears</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">C_train</span><span class="p">)))</span>
<span class="n">naive_preds</span> <span class="o">=</span> <span class="n">project_all</span><span class="p">(</span><span class="n">notears</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">C_test</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train L2:  </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">naive_preds_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test L2:   </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">naive_preds</span><span class="p">,</span> <span class="n">W_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train MSE: </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">naive_preds_train</span><span class="p">),</span> <span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test MSE:  </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">naive_preds</span><span class="p">),</span> <span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="context-clustered-networks">
<h3>2.3: Context-clustered Networks<a class="headerlink" href="#context-clustered-networks" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cluster Model</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">C_train</span><span class="p">)</span>
<span class="n">train_cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">C_train</span><span class="p">)</span>
<span class="n">test_cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">C_test</span><span class="p">)</span>
<span class="n">clustered_model</span> <span class="o">=</span> <span class="n">GroupedNetworks</span><span class="p">(</span><span class="n">BayesianNetwork</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">train_cluster_labels</span><span class="p">)</span>

<span class="n">clustered_preds_train</span> <span class="o">=</span> <span class="n">project_all</span><span class="p">(</span><span class="n">clustered_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_cluster_labels</span><span class="p">))</span>
<span class="n">clustered_preds</span> <span class="o">=</span> <span class="n">project_all</span><span class="p">(</span><span class="n">clustered_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_cluster_labels</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train L2: </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">clustered_preds_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test L2:  </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">clustered_preds</span><span class="p">,</span> <span class="n">W_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train mse: </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">clustered_preds_train</span><span class="p">),</span> <span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test mse:  </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">clustered_preds</span><span class="p">),</span> <span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="contextualized-networks">
<h3>2.4: Contextualized Networks<a class="headerlink" href="#contextualized-networks" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks.early_stopping</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">C_train_sansval</span><span class="p">,</span> <span class="n">C_val</span><span class="p">,</span> <span class="n">X_train_sansval</span><span class="p">,</span> <span class="n">X_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">C_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">train_datamodule</span> <span class="o">=</span> <span class="n">CX_DataModule</span><span class="p">(</span><span class="n">C_train_sansval</span><span class="p">,</span> <span class="n">X_train_sansval</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">val_datamodule</span> <span class="o">=</span> <span class="n">CX_DataModule</span><span class="p">(</span><span class="n">C_val</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">test_datamodule</span> <span class="o">=</span> <span class="n">CX_DataModule</span><span class="p">(</span><span class="n">C_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">contextualized_model</span> <span class="o">=</span> <span class="n">NOTMAD_model</span><span class="p">(</span>
    <span class="n">train_datamodule</span><span class="p">,</span>
    <span class="n">n_archetypes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">encoder_type</span><span class="o">=</span><span class="s1">&#39;mlp&#39;</span><span class="p">,</span>
    <span class="n">encoder_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
    <span class="n">sample_specific_loss_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;l1&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">},</span>
    <span class="n">archetype_loss_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;l1&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">},</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> 
    <span class="n">dirpath</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;notmad_checkpoints&#39;</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{epoch}</span><span class="s1">-</span><span class="si">{val_loss:.2f}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">es_callback</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> 
    <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
    <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span>
<span class="p">)</span>
<span class="n">accelerator</span> <span class="o">=</span> <span class="s1">&#39;gpu&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">auto_lr_find</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">accelerator</span><span class="o">=</span><span class="n">accelerator</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">checkpoint_callback</span><span class="p">,</span> <span class="n">es_callback</span><span class="p">])</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">contextualized_model</span><span class="p">,</span> <span class="n">train_datamodule</span><span class="p">)</span>

<span class="c1"># Get best checkpoint by val_loss, test and save</span>
<span class="n">best_checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_callback</span><span class="o">.</span><span class="n">best_model_path</span><span class="p">)</span>
<span class="n">contextualized_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_checkpoint</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>

<span class="n">notmad_preds_train</span> <span class="o">=</span> <span class="n">project_all</span><span class="p">(</span><span class="n">contextualized_model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">C_train</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">notmad_preds</span> <span class="o">=</span> <span class="n">project_all</span><span class="p">(</span><span class="n">contextualized_model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">C_test</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train L2: </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">notmad_preds_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test L2:  </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">notmad_preds</span><span class="p">,</span> <span class="n">W_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train mse: </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">notmad_preds_train</span><span class="p">),</span> <span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test mse:  </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">dag_pred</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">notmad_preds</span><span class="p">),</span> <span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-networks">
<h3>2.4 Visualizing Networks<a class="headerlink" href="#visualizing-networks" title="Permalink to this headline">#</a></h3>
<p>Use the code below to visualize true and predicted networks</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">W_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">notmad_preds_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./demos"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Contextualized.ML Team<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>